From c4cde277e46e3485149309e4c336dd2fbe98d05b Mon Sep 17 00:00:00 2001
From: Maik Switalski <maik@zauberzeug.com>
Date: Fri, 9 Dec 2022 11:40:13 +0100
Subject: [PATCH 1/3] confusion_matrices.patch

---
 train.py | 29 +++++++++++++++++------------
 val.py   |  9 +++++++--
 2 files changed, 24 insertions(+), 14 deletions(-)

diff --git a/train.py b/train.py
index 8b5446e..024a030 100644
--- a/train.py
+++ b/train.py
@@ -16,6 +16,7 @@ Tutorial:   https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data
 """
 
 import argparse
+import json
 import math
 import os
 import random
@@ -347,17 +348,17 @@ def train(hyp, opt, device, callbacks):  # hyp is path/to/hyp.yaml or hyp dictio
             ema.update_attr(model, include=['yaml', 'nc', 'hyp', 'names', 'stride', 'class_weights'])
             final_epoch = (epoch + 1 == epochs) or stopper.possible_stop
             if not noval or final_epoch:  # Calculate mAP
-                results, maps, _ = validate.run(data_dict,
-                                                batch_size=batch_size // WORLD_SIZE * 2,
-                                                imgsz=imgsz,
-                                                half=amp,
-                                                model=ema.ema,
-                                                single_cls=single_cls,
-                                                dataloader=val_loader,
-                                                save_dir=save_dir,
-                                                plots=False,
-                                                callbacks=callbacks,
-                                                compute_loss=compute_loss)
+                results, confusion_matrices, maps, _ = validate.run(data_dict,
+                                                                    batch_size=batch_size // WORLD_SIZE * 2,
+                                                                    imgsz=imgsz,
+                                                                    half=amp,
+                                                                    model=ema.ema,
+                                                                    single_cls=single_cls,
+                                                                    dataloader=val_loader,
+                                                                    save_dir=save_dir,
+                                                                    plots=False,
+                                                                    callbacks=callbacks,
+                                                                    compute_loss=compute_loss)
 
             # Update best mAP
             fi = fitness(np.array(results).reshape(1, -1))  # weighted combination of [P, R, mAP@.5, mAP@.5-.95]
@@ -384,7 +385,11 @@ def train(hyp, opt, device, callbacks):  # hyp is path/to/hyp.yaml or hyp dictio
                 torch.save(ckpt, last)
                 if best_fitness == fi:
                     torch.save(ckpt, best)
-                if opt.save_period > 0 and epoch % opt.save_period == 0:
+                    if confusion_matrices:
+                        with open(w / f'epoch{epoch}.json', 'w+') as f:
+                            json.dump(confusion_matrices, f)
+                        torch.save(ckpt, w / f'epoch{epoch}.pt')
+                if (epoch > 0) and (opt.save_period > 0) and (epoch % opt.save_period == 0):
                     torch.save(ckpt, w / f'epoch{epoch}.pt')
                 del ckpt
                 callbacks.run('on_model_save', last, epoch, final_epoch, best_fitness, fi)
diff --git a/val.py b/val.py
index 8d27d9d..a684845 100644
--- a/val.py
+++ b/val.py
@@ -288,6 +288,11 @@ def run(
         for i, c in enumerate(ap_class):
             LOGGER.info(pf % (names[c], seen, nt[c], p[i], r[i], ap50[i], ap[i]))
 
+    confusion_matrices = {}
+    for i, c in enumerate(ap_class):
+        fn = tp[i] / r[i] - tp[i] if r[i] != 0 else 0
+        confusion_matrices[names[c]] = {'tp': int(tp[i]), 'fp': int(fp[i]), 'fn': int(fn)}
+    
     # Print speeds
     t = tuple(x.t / seen * 1E3 for x in dt)  # speeds per image
     if not training:
@@ -333,7 +338,7 @@ def run(
     maps = np.zeros(nc) + map
     for i, c in enumerate(ap_class):
         maps[c] = ap[i]
-    return (mp, mr, map50, map, *(loss.cpu() / len(dataloader)).tolist()), maps, t
+    return (mp, mr, map50, map, *(loss.cpu() / len(dataloader)).tolist()), confusion_matrices, maps, t
 
 
 def parse_opt():
@@ -394,7 +399,7 @@ def main(opt):
                 x, y = list(range(256, 1536 + 128, 128)), []  # x axis (image sizes), y axis
                 for opt.imgsz in x:  # img-size
                     LOGGER.info(f'\nRunning {f} --imgsz {opt.imgsz}...')
-                    r, _, t = run(**vars(opt), plots=False)
+                    r, _, _, t = run(**vars(opt), plots=False)
                     y.append(r + t)  # results and times
                 np.savetxt(f, y, fmt='%10.4g')  # save
             os.system('zip -r study.zip study_*.txt')
-- 
2.25.1

